name: üóÑÔ∏è Database Migration Workflow (local)

on:
  # Este workflow local destina-se a testes com `act` e n√£o deve rodar em pushes.
  workflow_dispatch:
    inputs:
      environment:
        description: 'üåç Selecione o Ambiente'
        required: true
        default: 'dev'
        type: choice
        options: [dev, hml, prod]
      command:
        description: '‚ö° Comando Flyway'
        required: true
        default: 'migrate'
        type: choice
        options: [info, validate, migrate, repair]
      approved:
        description: '‚úÖ Simular aprova√ß√£o manual (usado com act)'
        required: false
        default: 'false'
        type: choice
        options: [true, false]


jobs:
  validate_local:
    name: üîç Valida√ß√£o de Scripts (local)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: üîç Verificar Estrutura
        run: |
          if [ ! -d "sql" ]; then
            echo "::error::Diret√≥rio sql/ n√£o encontrado"
            exit 1
          fi

          for dir in ddl dml repeatable; do
            if [ ! -d "sql/$dir" ]; then
              echo "::warning::Diret√≥rio sql/$dir n√£o encontrado"
            fi
          done

      - name: üìù Validar Sintaxe SQL com sqlfluff
        run: |
          pip install sqlfluff --break-system-packages
          echo "::group::Valida√ß√£o de Scripts SQL"
          find sql -type f -name "*.sql" -exec sqlfluff lint {} \;
          echo "::endgroup::"

      - name: üîç Validar Nomenclatura
        run: |
          echo "::group::Valida√ß√£o de Nomenclatura"

          error_count=0
          error_files=""

          # Validar scripts versionados
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              basename=$(basename "$file")
              echo "üîé Verificando: $file"

              if [[ ! $basename =~ ^V[0-9]{14}__ ]]; then
                echo "::error file=$file::‚ùå $basename - N√£o segue o padr√£o V{YYYYMMDDHHMMSS}__"
                error_count=$((error_count + 1))
                error_files="$error_files\n- $file"
              else
                echo "‚úÖ $basename - OK"
              fi
            fi
          done < <(find sql/ddl sql/dml -type f -name "*.sql" 2>/dev/null)

          # Validar scripts repet√≠veis
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              basename=$(basename "$file")
              echo "üîé Verificando: $file"

              if [[ ! $basename =~ ^R__ ]]; then
                echo "::error file=$file::‚ùå $basename - N√£o segue o padr√£o R__"
                error_count=$((error_count + 1))
                error_files="$error_files\n- $file"
              else
                echo "‚úÖ $basename - OK"
              fi
            fi
          done < <(find sql/repeatable -type f -name "*.sql" 2>/dev/null)

          if [ $error_count -gt 0 ]; then
            echo "‚ùå Encontrados $error_count arquivo(s) com erro de nomenclatura:"
            echo -e "$error_files"
            exit 1
          fi

          echo "‚úÖ Todos os arquivos seguem o padr√£o de nomenclatura"
          echo "::endgroup::"

      - name: üìä Flyway - Info pr√©-valida√ß√£o (local)
        if: inputs.approved != 'true'
        run: |
          # Info para inspecionar o estado atual do banco antes da valida√ß√£o
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            info

      - name: üí° Garantir schema 'scheduler' existe (local)
        if: inputs.approved != 'true'
        run: |
          set -e
          DB_HOST=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://([^/:]+)(:[0-9]+)?/([^?]+).*|\1|')
          DB_NAME=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://[^/]+/([^?]+).*|\1|')
          docker run --rm -e PGPASSWORD="${FLYWAY_PASSWORD}" postgres:16 \
            psql -h "${DB_HOST}" -U "${FLYWAY_USER}" -d "${DB_NAME}" -c "CREATE SCHEMA IF NOT EXISTS scheduler;"

      - name: üîç Flyway - Validate (local)
        if: inputs.approved != 'true'
        run: |
          set -e
          # Se n√£o houver flyway_schema_history, pular a valida√ß√£o (banco novo)
          DB_HOST=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://([^/:]+)(:[0-9]+)?/([^?]+).*|\1|')
          DB_NAME=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://[^/]+/([^?]+).*|\1|')
          EXISTS=$(docker run --rm -e PGPASSWORD="${FLYWAY_PASSWORD}" postgres:16 \
            psql -h "${DB_HOST}" -U "${FLYWAY_USER}" -d "${DB_NAME}" -tAc "SELECT 1 FROM information_schema.tables WHERE table_schema='scheduler' AND table_name='flyway_schema_history';" || true)
          if [ "${EXISTS}" != "1" ]; then
            echo "‚ö†Ô∏è flyway_schema_history n√£o encontrada ‚Äî pulando 'flyway validate' (banco novo)."
          else
            docker run --rm \
              -v "${{ github.workspace }}:/workspace" \
              -w /workspace \
              -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
              flyway/flyway:${FLYWAY_VERSION} \
              validate
          fi

  approval_local:
    name: ‚úã Aprova√ß√£o Manual (local)
    needs: validate_local
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    steps:
      - name: Simular Aprova√ß√£o (local)
        run: |
          if [ "${{ inputs.approved }}" = "true" ]; then
            echo "‚úÖ Simula√ß√£o: Migra√ß√£o aprovada para ${{ inputs.environment }}"
          else
            echo "‚ö†Ô∏è Nenhuma simula√ß√£o de aprova√ß√£o fornecida. Continuando sem bloqueio para testes locais."
          fi
  migrate_local:
    name: üöÄ Execu√ß√£o da Migra√ß√£o (local)
    needs: [validate_local, approval_local]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    timeout-minutes: 30

    concurrency:
      group: flyway-${{ inputs.environment || 'dev' }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: Configurar Vari√°veis
        run: |
          # Use secrets when dispon√≠veis (CI). Para execu√ß√£o local com `act`,
          # faz fallback para o Postgres em Docker Desktop (host.docker.internal).
          echo "FLYWAY_URL=jdbc:postgresql://host.docker.internal:5432/appdb" >> $GITHUB_ENV
          echo "FLYWAY_USER=app" >> $GITHUB_ENV
          echo "FLYWAY_PASSWORD=app" >> $GITHUB_ENV

      - name: üìä Info Pr√©-Migra√ß√£o (CLI local)
        if: inputs.approved == 'true'
        run: |
          set -e
          echo "Baixando Flyway CLI ${FLYWAY_VERSION}..."
          curl -fsSL "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz" -o flyway.tgz
          TMP_DIR=$(mktemp -d)
          tar xzf flyway.tgz -C "$TMP_DIR" --strip-components=1
          echo "TMP_FLYWAY_DIR=$TMP_DIR" >> $GITHUB_ENV
          "$TMP_DIR"/flyway -url="${FLYWAY_URL}" -user="${FLYWAY_USER}" -password="${FLYWAY_PASSWORD}" info

      - name: üí° Garantir schema 'scheduler' existe (CLI local)
        if: inputs.approved == 'true'
        run: |
          set -e
          DB_HOST=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://([^/:]+)(:[0-9]+)?/([^?]+).*|\1|')
          DB_NAME=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://[^/]+/([^?]+).*|\1|')
          docker run --rm -e PGPASSWORD="${FLYWAY_PASSWORD}" postgres:16 \
            psql -h "${DB_HOST}" -U "${FLYWAY_USER}" -d "${DB_NAME}" -c "CREATE SCHEMA IF NOT EXISTS scheduler;"

      - name: üîç Dry-Run (Validate CLI local)
        if: inputs.command == 'migrate' && inputs.approved == 'true'
        run: |
          set -e
          # S√≥ validar se o hist√≥rico do Flyway j√° existir
          DB_HOST=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://([^/:]+)(:[0-9]+)?/([^?]+).*|\1|')
          DB_NAME=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://[^/]+/([^?]+).*|\1|')
          EXISTS=$(docker run --rm -e PGPASSWORD="${FLYWAY_PASSWORD}" postgres:16 \
            psql -h "${DB_HOST}" -U "${FLYWAY_USER}" -d "${DB_NAME}" -tAc "SELECT 1 FROM information_schema.tables WHERE table_schema='scheduler' AND table_name='flyway_schema_history';" || true)
          if [ "${EXISTS}" != "1" ]; then
            echo "‚ö†Ô∏è flyway_schema_history n√£o encontrada ‚Äî pulando 'flyway validate' (banco novo)."
          else
            "$TMP_FLYWAY_DIR"/flyway -url="${FLYWAY_URL}" -user="${FLYWAY_USER}" -password="${FLYWAY_PASSWORD}" validate
          fi

      - name: ‚ö° Executar Flyway
        id: migrate
        if: inputs.approved != 'true'
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            ${{ inputs.command || 'migrate' }}

      - name: ‚ö° Executar Flyway (CLI local)
        if: inputs.approved == 'true'
        id: migrate_cli
        run: |
          set -e
          "$TMP_FLYWAY_DIR"/flyway -url="${FLYWAY_URL}" -user="${FLYWAY_USER}" -password="${FLYWAY_PASSWORD}" ${{ inputs.command || 'migrate' }}

      - name: üìà Info P√≥s-Migra√ß√£o
        if: always() && inputs.approved != 'true'
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            info

      - name: üìà Info P√≥s-Migra√ß√£o (CLI local)
        if: always() && inputs.approved == 'true'
        run: |
          set -e || true
          if [ -n "${TMP_FLYWAY_DIR:-}" ] && [ -x "${TMP_FLYWAY_DIR}/flyway" ]; then
            "${TMP_FLYWAY_DIR}"/flyway -url="${FLYWAY_URL}" -user="${FLYWAY_USER}" -password="${FLYWAY_PASSWORD}" info || true
            rm -rf "${TMP_FLYWAY_DIR}" || true
          fi
