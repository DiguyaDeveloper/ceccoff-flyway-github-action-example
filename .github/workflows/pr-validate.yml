name: üîç SQL Validation

on:
  pull_request:
    branches: [ main ]
    paths: [ "sql/**" ]
  workflow_dispatch:

env:
  SQL_DIALECT: postgres

jobs:
  validate-changes:
    name: üìù Validar Altera√ß√µes SQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîé Identificar Arquivos
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            FILES=$(git diff --name-only --diff-filter=ACMRT origin/${{ github.base_ref }}... | grep '^sql/.*\.sql$' || true)
          else
            FILES=$(find sql -type f -name "*.sql" 2>/dev/null || true)
          fi

          if [ -n "$FILES" ]; then
            echo "Arquivos encontrados:"
            echo "$FILES" | while read -r file; do
              echo "  - $file"
            done
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "Nenhum arquivo SQL encontrado"
            echo "files=" >> $GITHUB_OUTPUT
          fi

      - name: üîç Validar Nomenclatura
        run: |
          echo "::group::Valida√ß√£o de Nomenclatura de Scripts SQL"
          FILES="${{ steps.changed-files.outputs.files }}"

          if [ -z "$FILES" ]; then
            echo "‚è≠Ô∏è Skip: Nenhum arquivo SQL para validar"
            exit 0
          fi

          error_count=0
          error_files=""

          echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
            echo "üîé Verificando: $file"
            basename=$(basename "$file")

            if [[ "$file" == *"/repeatable/"* ]]; then
              if [[ ! "$basename" =~ ^R__[a-zA-Z0-9_]+\.sql$ ]]; then
                echo "::error file=$file::‚ùå $basename - Deve seguir o padr√£o R__{nome}.sql"
                error_count=$((error_count + 1))
                error_files="$error_files\n- $file"
              else
                echo "‚úÖ Nomenclatura v√°lida: $basename"
              fi
            elif [[ "$file" =~ /ddl/|/dml/ ]]; then
              if [[ ! "$basename" =~ ^V[0-9]{14}__[a-zA-Z0-9_]+\.sql$ ]]; then
                echo "::error file=$file::‚ùå $basename - Deve seguir o padr√£o V{YYYYMMDDHHMMSS}__{nome}.sql"
                error_count=$((error_count + 1))
                error_files="$error_files\n- $file"
              else
                echo "‚úÖ Nomenclatura v√°lida: $basename"
              fi
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo "‚ùå $error_count arquivo(s) com nomenclatura inv√°lida:"
            echo -e "$error_files"
            exit 1
          fi
          echo "::endgroup::"

      - name: üîß Instalar SQLFluff
        if: steps.changed-files.outputs.files != ''
        run: |
          pip install sqlfluff==2.3.5 --break-system-packages

      - name: üìù Validar Coment√°rios
        run: |
          echo "::group::Valida√ß√£o de Coment√°rios"
          FILES="${{ steps.changed-files.outputs.files }}"

          if [ -z "$FILES" ]; then
            echo "‚è≠Ô∏è Skip: Nenhum arquivo SQL para validar"
            exit 0
          fi

          error_count=0
          error_files=""

          echo "$FILES" | while read -r file; do
            echo "üîé Verificando coment√°rios: $file"
            if ! head -1 "$file" | grep -q "^--"; then
              echo "::error file=$file::‚ùå Arquivo deve come√ßar com coment√°rio (-- Descri√ß√£o)"
              error_count=$((error_count + 1))
              error_files="$error_files\n- $file"
            else
              echo "‚úÖ Coment√°rio presente: $file"
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo "‚ùå $error_count arquivo(s) sem coment√°rio inicial:"
            echo -e "$error_files"
            exit 1
          fi
          echo "::endgroup::"

      - name: üìù Validar Sintaxe SQL
        run: |
          echo "::group::Valida√ß√£o de Sintaxe SQL"
          FILES="${{ steps.changed-files.outputs.files }}"

          if [ -z "$FILES" ]; then
            echo "‚è≠Ô∏è Skip: Nenhum arquivo SQL para validar"
            exit 0
          fi

          error_count=0
          error_files=""

          echo "$FILES" | while read -r file; do
            echo "üîé Analisando: $file"
            if ! sqlfluff lint "$file" --dialect ${{ env.SQL_DIALECT }}; then
              echo "::error file=$file::‚ùå Erro de sintaxe SQL"
              error_count=$((error_count + 1))
              error_files="$error_files\n- $file"
            else
              echo "‚úÖ Sintaxe SQL v√°lida: $file"
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo "‚ùå $error_count arquivo(s) com erro de sintaxe:"
            echo -e "$error_files"
            exit 1
          fi
          echo "::endgroup::"

      - name: üîÑ Formatar SQL
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.files != ''
        run: |
          echo "::group::Formata√ß√£o Autom√°tica SQL"
          FILES="${{ steps.changed-files.outputs.files }}"

          echo "$FILES" | while read -r file; do
            echo "üîÑ Formatando: $file"
            sqlfluff fix "$file" --dialect ${{ env.SQL_DIALECT }} --force
          done
          echo "::endgroup::"

      - name: üìä Resumo
        if: always()
        run: |
          FILES="${{ steps.changed-files.outputs.files }}"
          if [ -z "$FILES" ]; then
            echo "‚è≠Ô∏è Valida√ß√£o n√£o necess√°ria: Nenhum arquivo SQL alterado"
          else
            echo "‚úÖ Valida√ß√£o conclu√≠da com sucesso"
          fi
