name: ğŸ” SQL Validation

on:
  pull_request:
    branches: [ main ]
    paths: [ "sql/**" ]

jobs:
  validate-changes:
    name: ğŸ“ Validar AlteraÃ§Ãµes SQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Identificar Arquivos Alterados
        id: changed-files
        run: |
          echo "files=$(git diff --name-only origin/main... | grep '^sql/.*\.sql$' | xargs)" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Validar Nomenclatura
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "::group::ValidaÃ§Ã£o de Nomenclatura"
          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "ğŸ” Verificando $file"

            if [[ $file == sql/repeatable/* ]] && [[ ! $file =~ ^sql/repeatable/R__ ]]; then
              echo "::error::âŒ Scripts repetÃ­veis devem comeÃ§ar com R__"
              exit 1
            fi

            if [[ $file =~ sql/(ddl|dml)/* ]] && [[ ! $file =~ ^sql/(ddl|dml)/V[0-9]{14}__ ]]; then
              echo "::error::âŒ Scripts versionados devem seguir o padrÃ£o V{YYYYMMDDHHMMSS}__"
              exit 1
            fi

            echo "âœ… Nomenclatura vÃ¡lida"
          done
          echo "::endgroup::"

      - name: ğŸ” Validar Sintaxe SQL
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "::group::ValidaÃ§Ã£o de Sintaxe SQL"
          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "ğŸ“ Analisando $file..."
            if ! sqlformat --verify "$file"; then
              echo "::error::âŒ Erro de sintaxe em $file"
              exit 1
            fi
            echo "âœ… Sintaxe vÃ¡lida"
          done
          echo "::endgroup::"

      - name: ğŸ“Š Resumo
        if: always()
        run: |
          if [ "${{ steps.changed-files.outputs.files }}" == "" ]; then
            echo "â„¹ï¸ Nenhum arquivo SQL alterado"
          else
            echo "âœ… ValidaÃ§Ã£o concluÃ­da com sucesso"
          fi
