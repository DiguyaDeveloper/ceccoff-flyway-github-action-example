name: üóÑÔ∏è Flyway Migration (manual/local)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'üåç Ambiente (dev/hml/prod/local)'
        required: true
        default: 'dev'
        type: choice
        options: [local, dev, hml, prod]
      command:
        description: '‚ö° Comando Flyway'
        required: true
        default: 'migrate'
        type: choice
        options: [info, validate, migrate, repair]
      approved:
        description: '‚úÖ Auto-aprovar execu√ß√µes locais (act). Ignore em dev/hml/prod (usar aprova√ß√£o do ambiente).'
        required: true
        default: 'true'
        type: choice
        options: ['true', 'false']
      db_url:
        description: 'üîó DB URL (opcional para modo local)'
        required: false
      db_user:
        description: 'üë§ DB User (opcional para modo local)'
        required: false
      db_pass:
        description: 'üîí DB Password (opcional para modo local)'
        required: false

env:
  SQL_DIALECT: postgres

jobs:
  validate:
    name: üîç Validar Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: Definir ambiente
        run: echo "ENVIRONMENT=local" >> $GITHUB_ENV

      - name: Definir credenciais para valida√ß√£o
        run: |
          if [ "$ENVIRONMENT" = "local" ]; then
            if [ -z "${{ secrets.DB_URL }}" ] || [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASS }}" ]; then
              echo "::error::Defina os secrets DB_URL, DB_USER e DB_PASS para local."
              exit 1
            fi
            echo "Usando secrets para local."
            echo "FLYWAY_URL=${{ secrets.DB_URL }}" >> $GITHUB_ENV
            echo "FLYWAY_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
            echo "FLYWAY_PASSWORD=${{ secrets.DB_PASS }}" >> $GITHUB_ENV
          else
            if [ -z "${{ secrets.DB_URL }}" ] || [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASS }}" ]; then
              echo "::error::Defina os secrets DB_URL, DB_USER e DB_PASS no ambiente/repo para validar em $ENVIRONMENT."
              exit 1
            fi
            echo "Usando secrets configurados (repo/ambiente)."
            echo "FLYWAY_URL=${{ secrets.DB_URL }}" >> $GITHUB_ENV
            echo "FLYWAY_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
            echo "FLYWAY_PASSWORD=${{ secrets.DB_PASS }}" >> $GITHUB_ENV
          fi

      - name: üîç Verificar Estrutura
        run: |
          if [ ! -d "sql" ]; then
            echo "::error::Diret√≥rio sql/ n√£o encontrado"
            exit 1
          fi

          for dir in ddl dml repeatable; do
            if [ ! -d "sql/$dir" ]; then
              echo "::warning::Diret√≥rio sql/$dir n√£o encontrado"
            fi
          done

      - name: üìù Validar Sintaxe SQL com sqlfluff
        run: |
          pip install sqlfluff --break-system-packages
          echo "::group::Valida√ß√£o de Scripts SQL"
          find sql -type f -name "*.sql" -exec sqlfluff lint {} \;
          echo "::endgroup::"

      - name: üîç Validar Nomenclatura
        run: |
          echo "::group::Valida√ß√£o de Nomenclatura"

          error_count=0
          error_files=""

          # Versionados
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              basename=$(basename "$file")
              echo "üîé Verificando: $file"
              if [[ ! $basename =~ ^V[0-9]{14}__ ]]; then
                echo "::error file=$file::‚ùå $basename - N√£o segue o padr√£o V{YYYYMMDDHHMMSS}__"
                error_count=$((error_count + 1))
                error_files="$error_files\n- $file"
              else
                echo "‚úÖ $basename - OK"
              fi
            fi
          done < <(find sql/ddl sql/dml -type f -name "*.sql" 2>/dev/null)

          # Repet√≠veis
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              basename=$(basename "$file")
              echo "üîé Verificando: $file"
              if [[ ! $basename =~ ^R__ ]]; then
                echo "::error file=$file::‚ùå $basename - N√£o segue o padr√£o R__"
                error_count=$((error_count + 1))
                error_files="$error_files\n- $file"
              else
                echo "‚úÖ $basename - OK"
              fi
            fi
          done < <(find sql/repeatable -type f -name "*.sql" 2>/dev/null)

          if [ $error_count -gt 0 ]; then
            echo "‚ùå Encontrados $error_count arquivo(s) com erro de nomenclatura:"
            echo -e "$error_files"
            exit 1
          fi

          echo "‚úÖ Todos os arquivos seguem o padr√£o de nomenclatura"
          echo "::endgroup::"

      - name: üìä Flyway - Info pr√©-valida√ß√£o
        run: |
          docker run --rm --network host \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            info

      - name: üí° Garantir schema 'scheduler' existe
        run: |
          set -e
          DB_HOST=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://([^/:]+)(:[0-9]+)?/([^?]+).*|\1|')
          DB_NAME=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://[^/]+/([^?]+).*|\1|')
          docker run --rm --network host -e PGPASSWORD="${FLYWAY_PASSWORD}" postgres:16 \
            psql -h "${DB_HOST}" -U "${FLYWAY_USER}" -d "${DB_NAME}" -c "CREATE SCHEMA IF NOT EXISTS scheduler;"

      - name: üîç Flyway - Validate
        run: |
          set -e
          DB_HOST=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://([^/:]+)(:[0-9]+)?/([^?]+).*|\1|')
          DB_NAME=$(echo "${FLYWAY_URL}" | sed -E 's|jdbc:postgresql://[^/]+/([^?]+).*|\1|')
          EXISTS=$(docker run --rm --network host -e PGPASSWORD="${FLYWAY_PASSWORD}" postgres:16 \
            psql -h "${DB_HOST}" -U "${FLYWAY_USER}" -d "${DB_NAME}" -tAc "SELECT 1 FROM information_schema.tables WHERE table_schema='scheduler' AND table_name='flyway_schema_history';" || true)
          if [ "${EXISTS}" != "1" ]; then
            echo "‚ö†Ô∏è flyway_schema_history n√£o encontrada ‚Äî pulando 'flyway validate' (banco novo)."
          else
            docker run --rm --network host \
              -v "${{ github.workspace }}:/workspace" \
              -w /workspace \
              -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
              flyway/flyway:${FLYWAY_VERSION} \
              validate
          fi

  migrate_remote:
    name: üöÄ Executar Migra√ß√£o (ambiente)
    if: inputs.environment != 'local'
    runs-on: ubuntu-latest
    needs: [validate]
    environment: ${{ inputs.environment }}
    timeout-minutes: 30
    concurrency:
      group: flyway-${{ inputs.environment }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: Definir credenciais (ambiente)
        run: |
          if [ -z "${{ secrets.DB_URL }}" ] || [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASS }}" ]; then
            echo "::error::Defina os secrets do ambiente DB_URL, DB_USER e DB_PASS antes de migrar."
            exit 1
          fi
          echo "Usando secrets do ambiente GitHub."
          echo "FLYWAY_URL=${{ secrets.DB_URL }}" >> $GITHUB_ENV
          echo "FLYWAY_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "FLYWAY_PASSWORD=${{ secrets.DB_PASS }}" >> $GITHUB_ENV

      - name: ‚ö° Executar Flyway
        id: migrate
        run: |
          docker run --rm --network host \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            ${{ inputs.command || 'migrate' }}

      - name: üìà Info P√≥s-Migra√ß√£o
        if: always()
        run: |
          docker run --rm --network host \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            info

      - name: üì£ Notificar Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const notify = require('./.github/scripts/notify.js');
            await notify({
              github,
              context,
              status: "${{ job.status }}",
              environment: "${{ inputs.environment }}",
              command: "${{ inputs.command || 'migrate' }}"
            });

  migrate_local:
    name: üöÄ Executar Migra√ß√£o (local)
    if: inputs.environment == 'local'
    runs-on: ubuntu-latest
    needs: [validate]
    timeout-minutes: 30
    concurrency:
      group: flyway-local
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Checar flag approved para execu√ß√µes locais
        run: |
          if [ "${{ inputs.approved }}" != "true" ]; then
            echo "::error::Para executar local/act defina approved=true (simula√ß√£o de aprova√ß√£o)."
            exit 1
          fi

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: Definir credenciais (local)
        run: |
          if [ -z "${{ inputs.db_url }}" ] || [ -z "${{ inputs.db_user }}" ] || [ -z "${{ inputs.db_pass }}" ]; then
            echo "::error::Para environment=local, forne√ßa db_url, db_user e db_pass via inputs."
            exit 1
          fi
          echo "Usando credenciais fornecidas via inputs (local)."
          echo "FLYWAY_URL=${{ inputs.db_url }}" >> $GITHUB_ENV
          echo "FLYWAY_USER=${{ inputs.db_user }}" >> $GITHUB_ENV
          echo "FLYWAY_PASSWORD=${{ inputs.db_pass }}" >> $GITHUB_ENV

      - name: ‚ö° Executar Flyway
        id: migrate
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \Run Main Definir credenciais para valida√ß√£o
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            ${{ inputs.command || 'migrate' }}

      - name: üìà Info P√≥s-Migra√ß√£o
        if: always()
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            flyway/flyway:${FLYWAY_VERSION} \
            info
