name: üîç Validate PR

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  SQL_DIALECT: postgres

jobs:
  validate:
    name: üîç Validar Scripts SQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: üîç Verificar Estrutura
        run: chmod +x .github/workflows/shared/flows/validate-structure.sh && ./.github/workflows/shared/flows/validate-structure.sh

      - name: üìù Validar Sintaxe SQL
        run: chmod +x .github/workflows/shared/flows/validate-sql-syntax.sh && ./.github/workflows/shared/flows/validate-sql-syntax.sh

      - name: üîç Validar Nomenclatura
        run: chmod +x .github/workflows/shared/flows/validate-naming.sh && ./.github/workflows/shared/flows/validate-naming.sh

      - name: üîê Configurar Credenciais (Test DB)
        run: |
          chmod +x .github/workflows/shared/flows/setup-credentials.sh
          ./.github/workflows/shared/flows/setup-credentials.sh "test" "${{ secrets.DB_URL }}" "${{ secrets.DB_USER }}" "${{ secrets.DB_PASS }}"

      - name: üìä Flyway Info
        run: chmod +x .github/workflows/shared/flows/flyway-info.sh && ./.github/workflows/shared/flows/flyway-info.sh $FLYWAY_VERSION

      - name: üí° Garantir Schema
        run: chmod +x .github/workflows/validate-pr/flows/ensure-schema.sh && ./.github/workflows/validate-pr/flows/ensure-schema.sh

      - name: üîç Flyway Validate
        run: chmod +x .github/workflows/validate-pr/flows/flyway-validate.sh && ./.github/workflows/validate-pr/flows/flyway-validate.sh $FLYWAY_VERSION

      - name: üìä Gerar Relat√≥rio de Valida√ß√£o
        run: chmod +x .github/workflows/shared/flows/generate-report.sh && ./.github/workflows/shared/flows/generate-report.sh

      - name: üìã Exibir Tabela Detalhada
        run: chmod +x .github/workflows/shared/flows/generate-table.sh && ./.github/workflows/shared/flows/generate-table.sh

      - name: üìÑ Publicar Relat√≥rio
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.md
          retention-days: 30

      - name: üí¨ Comentar Resultado no PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('validation-report.md', 'utf8');

            // Gerar tabela resumida para coment√°rio
            const ddlCount = report.match(/DDL \| (\d+)/)?.[1] || '0';
            const dmlCount = report.match(/DML \| (\d+)/)?.[1] || '0';
            const repeatableCount = report.match(/Repeatable \| (\d+)/)?.[1] || '0';
            const totalCount = report.match(/\*\*Total\*\* \| \*\*(\d+)\*\*/)?.[1] || '0';

            const comment = `## ‚úÖ Valida√ß√£o dos Scripts SQL

### üìä Resumo da Valida√ß√£o

| Tipo | Quantidade | Status |
|------|------------|--------|
| DDL | ${ddlCount} | ‚úÖ Validado |
| DML | ${dmlCount} | ‚úÖ Validado |
| Repeatable | ${repeatableCount} | ‚úÖ Validado |
| **Total** | **${totalCount}** | ‚úÖ **Aprovado** |

### üîç Detalhes da Valida√ß√£o
- ‚úÖ Estrutura de diret√≥rios verificada
- ‚úÖ Sintaxe SQL validada com sqlfluff
- ‚úÖ Nomenclatura dos arquivos OK
- ‚úÖ Schema 'scheduler' garantido
- ‚úÖ Flyway validate executado com sucesso

**Relat√≥rio completo dispon√≠vel nos artifacts desta execu√ß√£o.**

*Executado em: ${new Date().toLocaleString('pt-BR')}*`;

            // Buscar coment√°rio existente
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('## ‚úÖ Valida√ß√£o dos Scripts SQL')
            );

            if (existingComment) {
              // Atualizar coment√°rio existente
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Criar novo coment√°rio
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
