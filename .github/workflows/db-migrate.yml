name: ðŸ—„ï¸ Database Migration Workflow

on:
  push:
    branches: [ main ]
    paths: [ "sql/**" ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ðŸŒ Selecione o Ambiente'
        required: true
        default: 'dev'
        type: choice
        options: [dev, hml, prod]
      command:
        description: 'âš¡ Comando Flyway'
        required: true
        default: 'migrate'
        type: choice
        options: [info, validate, migrate, repair]

env:
  FLYWAY_VERSION: 10.18.2
  FLYWAY_SCHEMAS: scheduler
  FLYWAY_DEFAULT_SCHEMA: scheduler

jobs:
  validate:
    name: ðŸ” ValidaÃ§Ã£o de Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Verificar Estrutura
        run: |
          if [ ! -d "sql" ]; then
            echo "::error::DiretÃ³rio sql/ nÃ£o encontrado"
            exit 1
          fi

          for dir in ddl dml repeatable; do
            if [ ! -d "sql/$dir" ]; then
              echo "::warning::DiretÃ³rio sql/$dir nÃ£o encontrado"
            fi
          done

      - name: ðŸ“ Validar Sintaxe SQL
        run: |
          echo "::group::ValidaÃ§Ã£o de Scripts SQL"
          find sql -type f -name "*.sql" -print0 | while IFS= read -r -d '' file; do
            echo "ðŸ”Ž Analisando $file"
            # Aqui iremos apenas verificar se o arquivo existe e Ã© legÃ­vel
            if [ ! -r "$file" ]; then
              echo "::error file=$file::Arquivo nÃ£o pode ser lido"
              exit 1
            fi
          done
          echo "::endgroup::"

      - name: ðŸ” Validar Nomenclatura
        run: |
          echo "::group::ValidaÃ§Ã£o de Nomenclatura"
          # Validar scripts versionados
          find sql/ddl sql/dml -type f -name "*.sql" 2>/dev/null | while read file; do
            basename=$(basename "$file")
            if [[ ! $basename =~ ^V[0-9]{14}__ ]]; then
              echo "::error file=$file::Arquivo nÃ£o segue o padrÃ£o V{YYYYMMDDHHMMSS}__"
              exit 1
            fi
          done

          # Validar scripts repetÃ­veis
          find sql/repeatable -type f -name "*.sql" 2>/dev/null | while read file; do
            basename=$(basename "$file")
            if [[ ! $basename =~ ^R__ ]]; then
              echo "::error file=$file::Arquivo nÃ£o segue o padrÃ£o R__"
              exit 1
            fi
          done
          echo "::endgroup::"

  approval:
    name: âœ‹ AprovaÃ§Ã£o Manual
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    if: inputs.environment != 'dev'
    steps:
      - run: echo "âœ… MigraÃ§Ã£o aprovada para ${{ inputs.environment }}"

  migrate:
    name: ðŸš€ ExecuÃ§Ã£o da MigraÃ§Ã£o
    needs: [validate, approval]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}

    concurrency:
      group: flyway-${{ inputs.environment || 'dev' }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Configurar VariÃ¡veis
        run: |
          echo "FLYWAY_URL=${{ secrets.DB_URL }}" >> $GITHUB_ENV
          echo "FLYWAY_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "FLYWAY_PASSWORD=${{ secrets.DB_PASS }}" >> $GITHUB_ENV

      - name: ðŸ“Š Info PrÃ©-MigraÃ§Ã£o
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/sql:/flyway/sql" \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            -e FLYWAY_SCHEMAS -e FLYWAY_DEFAULT_SCHEMA \
            flyway/flyway:${{ env.FLYWAY_VERSION }} \
            info

      - name: âš¡ Executar Flyway
        id: migrate
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/sql:/flyway/sql" \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            -e FLYWAY_SCHEMAS -e FLYWAY_DEFAULT_SCHEMA \
            flyway/flyway:${{ env.FLYWAY_VERSION }} \
            ${{ inputs.command || 'migrate' }}

      - name: ðŸ“ˆ Info PÃ³s-MigraÃ§Ã£o
        if: always()
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/sql:/flyway/sql" \
            -e FLYWAY_URL -e FLYWAY_USER -e FLYWAY_PASSWORD \
            -e FLYWAY_SCHEMAS -e FLYWAY_DEFAULT_SCHEMA \
            flyway/flyway:${{ env.FLYWAY_VERSION }} \
            info

      - name: ðŸ“£ Notificar Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const notify = require('./.github/scripts/notify.js');
            await notify({
              github,
              context,
              status: "${{ job.status }}",
              environment: "${{ inputs.environment || 'dev' }}",
              command: "${{ inputs.command || 'migrate' }}"
            });
