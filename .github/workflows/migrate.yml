name: ğŸ—„ï¸ Flyway Migrate

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ğŸŒ Ambiente (dev/hml/prod/local)'
        required: true
        default: 'dev'
        type: choice
        options: [local, dev, hml, prod]
      command:
        description: 'âš¡ Comando Flyway'
        required: true
        default: 'migrate'
        type: choice
        options: [info, validate, migrate, repair]
      approved:
        description: 'âœ… Auto-aprovar execuÃ§Ãµes locais (act). Ignore em dev/hml/prod.'
        required: true
        default: 'true'
        type: choice
        options: ['true', 'false']
      db_url:
        description: 'ğŸ”— DB URL (opcional para modo local)'
        required: false
      db_user:
        description: 'ğŸ‘¤ DB User (opcional para modo local)'
        required: false
      db_pass:
        description: 'ğŸ”’ DB Password (opcional para modo local)'
        required: false

env:
  SQL_DIALECT: postgres

jobs:
  validate:
    name: ğŸ” Validar Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: ğŸ” Verificar Estrutura
        run: chmod +x .github/workflows/shared/flows/validate-structure.sh && ./.github/workflows/shared/flows/validate-structure.sh

      - name: ğŸ“ Validar Sintaxe SQL
        run: chmod +x .github/workflows/shared/flows/validate-sql-syntax.sh && ./.github/workflows/shared/flows/validate-sql-syntax.sh

      - name: ğŸ” Validar Nomenclatura
        run: chmod +x .github/workflows/shared/flows/validate-naming.sh && ./.github/workflows/shared/flows/validate-naming.sh

      - name: ğŸ“Š Gerar RelatÃ³rio
        run: chmod +x .github/workflows/shared/flows/generate-table.sh && ./.github/workflows/shared/flows/generate-table.sh

  migrate_remote:
    name: ğŸš€ Executar MigraÃ§Ã£o (Ambiente)
    if: inputs.environment != 'local'
    runs-on: ubuntu-latest
    needs: [validate]
    environment: ${{ inputs.environment }}
    timeout-minutes: 30
    concurrency:
      group: flyway-${{ inputs.environment }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: ğŸ” Configurar Credenciais
        run: |
          chmod +x .github/workflows/shared/flows/setup-credentials.sh
          ./.github/workflows/shared/flows/setup-credentials.sh "${{ inputs.environment }}" "${{ secrets.DB_URL }}" "${{ secrets.DB_USER }}" "${{ secrets.DB_PASS }}"

      - name: ğŸš€ Executar Flyway
        run: chmod +x .github/workflows/migrate/flows/flyway-migrate.sh && ./.github/workflows/migrate/flows/flyway-migrate.sh $FLYWAY_VERSION ${{ inputs.command }}

      - name: ğŸ“ˆ Info PÃ³s-MigraÃ§Ã£o
        if: always()
        run: chmod +x .github/workflows/shared/flows/flyway-info.sh && ./.github/workflows/shared/flows/flyway-info.sh $FLYWAY_VERSION

      - name: ğŸ“£ Notificar Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const notify = require('./.github/scripts/notify.js');
            await notify({
              github,
              context,
              status: "${{ job.status }}",
              environment: "${{ inputs.environment }}",
              command: "${{ inputs.command }}"
            });

  migrate_local:
    name: ğŸš€ Executar MigraÃ§Ã£o (Local)
    if: inputs.environment == 'local' && inputs.approved == 'true'
    runs-on: ubuntu-latest
    needs: [validate]
    timeout-minutes: 30
    concurrency:
      group: flyway-local
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Checar AprovaÃ§Ã£o Local
        run: |
          if [ "${{ inputs.approved }}" != "true" ]; then
            echo "::error::Para execuÃ§Ãµes locais, defina approved=true"
            exit 1
          fi

      - name: Carregar Flyway version
        run: |
          if [ -f .flyway-version ]; then
            echo "FLYWAY_VERSION=$(cat .flyway-version)" >> $GITHUB_ENV
          else
            echo "FLYWAY_VERSION=10.18.2" >> $GITHUB_ENV
          fi

      - name: ğŸ” Configurar Credenciais
        run: |
          chmod +x .github/workflows/shared/flows/setup-credentials.sh
          ./.github/workflows/shared/flows/setup-credentials.sh "local" "${{ inputs.db_url }}" "${{ inputs.db_user }}" "${{ inputs.db_pass }}"

      - name: ğŸš€ Executar Flyway
        run: chmod +x .github/workflows/migrate/flows/flyway-migrate.sh && ./.github/workflows/migrate/flows/flyway-migrate.sh $FLYWAY_VERSION ${{ inputs.command }}

      - name: ğŸ“ˆ Info PÃ³s-MigraÃ§Ã£o
        if: always()
        run: chmod +x .github/workflows/shared/flows/flyway-info.sh && ./.github/workflows/shared/flows/flyway-info.sh $FLYWAY_VERSION

      - name: ğŸ“Š Gerar RelatÃ³rio de MigraÃ§Ã£o
        if: always()
        run: |
          chmod +x .github/workflows/shared/flows/generate-report.sh
          ENVIRONMENT="${{ inputs.environment }}" ./.github/workflows/shared/flows/generate-report.sh

      - name: ğŸ“‹ Exibir Tabela Detalhada
        if: always()
        run: chmod +x .github/workflows/shared/flows/generate-table.sh && ENVIRONMENT="${{ inputs.environment }}" ./.github/workflows/shared/flows/generate-table.sh

      - name: ğŸ“„ Publicar RelatÃ³rio de MigraÃ§Ã£o
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-report-${{ inputs.environment }}
          path: validation-report.md
          retention-days: 30
